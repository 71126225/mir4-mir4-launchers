import { createUnplugin } from 'unplugin';
import { once } from 'lodash-es';
import { useLogger, useUnlighthouse, createUnlighthouse } from '@unlighthouse/core';
import { createServer } from '@unlighthouse/server';

const PLUGIN_NAME = "unlighthouse:webpack";
const setupWebpack = once(async (config, compiler) => {
  const logger = useLogger();
  logger.debug("Setting up unlighthouse webpack plugin.");
  if (compiler.options.mode !== "development") {
    logger.debug("Not starting unlighthouse, webpack is not in development mode.");
    return;
  }
  const linkUnlighthouse = once(() => {
    const unlighthouse2 = useUnlighthouse();
    logger.success(`\u26F5  Start Unlighthouse - ${unlighthouse2.runtimeSettings.clientUrl}`);
  });
  compiler.hooks.done.tap("unlighthouse", linkUnlighthouse);
  compiler.hooks.invalid.tap(PLUGIN_NAME, (resource) => {
    if (!resource)
      return;
    const { worker } = useUnlighthouse();
    worker.invalidateFile(resource);
  });
  const ensureUnlighthouse = async () => {
    const unlighthouse2 = useUnlighthouse();
    if (unlighthouse2)
      return unlighthouse2;
    return await createUnlighthouse({
      ...config,
      root: compiler.options.context
    }, {
      name: "webpack"
    });
  };
  const unlighthouse = await ensureUnlighthouse();
  const setupServer = async () => {
    const ensureServer = async () => {
      if (unlighthouse.runtimeSettings.server)
        return unlighthouse.runtimeSettings.server;
      const { server, app } = await createServer();
      await unlighthouse.setServerContext({ url: server.url, server: server.server, app });
      return server;
    };
    await ensureServer();
  };
  if (unlighthouse.resolvedConfig.site) {
    await setupServer();
  } else {
    unlighthouse.hooks.hookOnce("site-changed", async () => {
      await setupServer();
    });
  }
});
function WebpackPlugin(configOrPath) {
  return createUnplugin(() => {
    return {
      name: "unlighthouse:webpack",
      webpack(compiler) {
        setupWebpack(configOrPath, compiler);
      }
    };
  }).webpack();
}

export { WebpackPlugin as default };
